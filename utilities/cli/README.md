# Tether CLI

## Install on your system

It's very convenient to have the command available system-wide. From _this_ directory (`./utilies/cli`), you can run the following (possibly with `sudo`):

```
npm install -g .
```

Now you can run any of the following from the command-line without explicitly invoking NodeJS:

- `tether-receive`
- `tether-send`
- `tether-topics`
- `tether-record`
- `tether-playback`

## Override default settings

Both `tether-send` and `tether-receive` use some defaults, for convenience. Most importantly, they assume you want to connect to an MQTT Broker running on `tcp://localhost:1883`

You can override any of these using command-line flags, e.g.

```
tether-send --host tether-io.dev
```

---

## tether-receive

### Defaults and overrides

By default, subscribes to ALL topics (MQTT topic wildcard `"#"`) - you might want to narrow this down, e.g.:

```
tether-receive --topic some/other/topic
```

The process runs "forever" till you press `Ctrl+C`.

### Decoding

This utility does not do much more than an ordinary MQTT client, except for attempting to decode the message payload (content) using MessagePack.

### Format as JSON

Easily pipe valid JSON array to a file:

```
node tether-receive.js --json.enabled=true > test.json
```

All logging messages (except for `fatal` level) will be suppressed. Even `^C` (Crl + C) will be handled internally and the JSON array will be closed off before actually exiting the process.

---

## tether-send

Similar defaults and options as per `tether-receive` but you might also want to set the message (JSON, but escape **quote marks**, **square brackets** and **curly braces**) and topic, e.g.:

```
tether-send --message \{\"foo\":\[1,2,3\]\} --topic "my/custom/topic"
```

This utility publishes a single message, then exits.

---

## tether-topics

This utility listens to all messages on all topics, and tries to build up a list of topics as messages are received. From topics, it also parses agent types, agent IDs and output names.

Example output:

```
{
  topics: [ 'my/custom/topic', 'tether-send/unknown/dummy' ],
  agentTypes: [ 'my', 'tether-send' ],
  agentIds: [ 'custom', 'unknown' ],
  outputNames: [ 'topic', 'dummy' ]
}
```

Runs continuously till you press `Ctrl+C`.

This utility cannot see into the "past", i.e. it will only list topics for messages it has received since it connected - the exception is messages that are explicitly set to be `retained` on the MQTT Broker.

---

## Tether Record

Works almost identically to `tether-receive`, except that it does **not** attempt to decode message payloads.

You can specify a path, file name and optional (auto-appended) timestamp for the file created to save all messages.

The defaults:

```
file: {
  basePath: "./",
  baseName: "recording",
  nameIncludesTimestamp: true,
}
```

Every single message entry is saved with its own **topic**, **deltaTime** (milliseconds since previous message) and **message** (u8 buffer payload). This allows Tether Playback (see [below](#tether-playback)) to reconstruct the timing and behaviour of the original source(s) as closely as possible.

## Tether Playback

This is the counterpart to Tether Record, as described [above](#tether-record).

This utility reads a JSON file in the format generated by Tether Record, and using the timing information to simulate the data/events of one or more Agents.

You can loop the playback either a set number of times using `--loops=3` or "forever" using `--loopInfinite=true`.

The topic(s) from the original messages will be used by default. You can override this by passing `--overrideTopic some/other/topic` if you need to, but be aware that _all_ messages will be published on this topic regardless of the original topics saved in the file.
